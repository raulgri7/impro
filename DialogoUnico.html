<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maestro de Improvisación IA 🎭</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* -------------------------------------------
            ESTILOS CSS - Diseño Final (10 Tarjetas Detalladas)
            ------------------------------------------- */
        :root {
            --color-main: #34495e; /* Azul oscuro/Gris Pizarra */
            --color-accent: #2ecc71; /* Verde esmeralda (Accent) */
            --color-highlight: #3498db; /* Azul claro para elementos clave */
            --color-bg: #ecf0f1; /* Fondo gris claro */
            --color-card-bg: #ffffff; /* Fondo tarjeta BLANCO PURO */
            --shadow-hover: 0 4px 10px rgba(0, 0, 0, 0.1); 
            --shadow-button: 0 4px 0 #27ae60;
            --color-print-button: #e74c3c; /* Rojo para imprimir */
        }

        * {
            box-sizing: border-box;
        }

        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 20px; 
            max-width: 1200px;
            margin: 0 auto; 
            background-color: var(--color-bg); 
            color: var(--color-main);
            line-height: 1.5;
        }

        /* Encabezado y títulos */
        h1 { 
            color: var(--color-main); 
            padding-bottom: 12px; 
            margin-bottom: 25px; 
            text-align: center;
            font-size: 2.2em;
            font-weight: 900;
        }

        p.instruccion { 
            color: var(--color-main); 
            margin-bottom: 30px; 
            font-style: italic; 
            text-align: center;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            font-size: 1.05em;
        }

        .botones-container {
            display: flex;
            justify-content: center; 
            gap: 20px; /* Espacio entre botones */
            margin-bottom: 40px;
        }

        /* Estilos del Botón de Generar */
        button { 
            padding: 16px 30px; 
            background-color: var(--color-accent); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 1.1em;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease; 
            box-shadow: var(--shadow-button); 
            min-width: 250px;
            text-transform: uppercase;
        }
        button:hover:not(:disabled) { background-color: #27ae60; }
        button:active:not(:disabled) { 
            transform: translateY(4px); 
            box-shadow: 0 0 0 #27ae60;
        }
        button:disabled {
            background-color: #bdc3c7;
            box-shadow: 0 4px 0 #95a5a6;
            cursor: not-allowed;
        }
        
        /* Estilos del Botón de Imprimir */
        #boton-imprimir {
            background-color: var(--color-print-button);
            box-shadow: 0 4px 0 #c0392b;
            display: none; /* Ocultar por defecto */
        }
        #boton-imprimir:hover {
            background-color: #c0392b;
        }
        #boton-imprimir:active {
            transform: translateY(4px); 
            box-shadow: 0 0 0 #c0392b;
        }


        /* Contenedor de Resultado: BORDES CUADRADOS Y SIN ESPACIOS */
        #resultado { 
            padding: 0; 
            border: 1px solid #bdc3c7;
            background-color: var(--color-card-bg);
            border-radius: 0; 
            min-height: 280px;
            display: grid;
            /* Intentar 2 columnas para desktop para el nuevo formato detallado */
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); 
            gap: 0; 
            position: relative; 
            box-shadow: none; 
        }
        
        /* Placeholder inicial */
        #resultado:has(> .instruccion:first-child) {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 280px;
            padding: 30px 15px; 
        }

        /* Estilos para las Tarjetas Generadas - TROQUELADO UNIDO */
        .tarjeta-impro {
            padding: 25px 20px;
            background-color: var(--color-card-bg);
            border-radius: 0; 
            box-shadow: none; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            
            /* Borde punteado para el troquelado: solo abajo y derecha */
            border: 0;
            border-right: 3px dashed #95a5a6; 
            border-bottom: 3px dashed #95a5a6; 
            overflow: hidden; 
        }
        .tarjeta-impro:hover {
            transform: none; 
            box-shadow: var(--shadow-hover);
            z-index: 1; 
        }
        
        /* Reglas de borde para la cuadrícula (Desktop, 2 columnas) */
        #resultado .tarjeta-impro:nth-child(2n) {
            border-right: none;
        }
        #resultado .tarjeta-impro:nth-last-child(-n + 2) {
             border-bottom: none;
        }
        
        /* Estilos de Contenido de Tarjeta (Ajustados para el formato detallado) */
        .tarjeta-titulo { 
            font-weight: 900;
            font-size: 1.4em;
            color: var(--color-highlight);
            margin-bottom: 10px;
            text-align: center;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }
        .separador { 
            border-top: 2px solid #ecf0f1;
            margin-bottom: 15px;
        }
        .tarjeta-item { 
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .tarjeta-item strong { 
            font-weight: 700;
            display: block;
            margin-top: 10px; 
            text-transform: uppercase;
            font-size: 0.9em;
            color: var(--color-main);
            border-bottom: 1px dotted #ccc;
            padding-bottom: 3px;
        }
        .tarjeta-item span { 
            display: block;
            font-weight: 400;
            color: #555;
            padding-left: 0;
            margin-top: 5px;
        }
        .modo-tag { 
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 0.7em;
            color: #95a5a6;
            z-index: 10;
        }

        /* Estilos específicos para el diálogo y las pautas */
        .dialogo-bloque { 
            white-space: pre-line; 
            font-style: italic; 
            margin-top: 8px; 
            background-color: #f7f9f9; 
            padding: 10px; 
            border-left: 3px solid var(--color-highlight);
            color: #222;
        }
        .dialogo-bloque span { display: block; }
        .pautas-lista { 
            margin-top: 8px; 
            padding-left: 20px; 
            list-style-type: square;
        }
        .pautas-lista li { 
            margin-bottom: 5px; 
            color: #555; 
            padding-left: 5px;
        }
        .extension-bloque {
            font-size: 0.9em;
            color: #777;
            font-style: italic;
        }


        /* -------------------------------------------
            REGLAS DE IMPRESIÓN - OPTIMIZACIÓN A4 (2x5 por página)
            ------------------------------------------- */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0.8cm !important; /* Márgenes ajustados */
            }

            body { 
                background-color: white !important; 
                padding: 0 !important;
                margin: 0 !important;
            }
            /* Ocultar elementos de UI */
            h1, p.instruccion, .botones-container, .modo-tag, .noprint { 
                display: none; 
            }
            
            #resultado {
                box-shadow: none;
                border: none;
                padding: 0;
                background-color: white;
                /* Cuadrícula de 2 columnas */
                grid-template-columns: repeat(2, 1fr); 
                gap: 0; 
                margin: 0;
            }
            
            .tarjeta-impro {
                /* Usar borde en todos los lados para que se vean bien las líneas de corte */
                border: 1.5px dashed #555 !important; 
                box-shadow: none;
                transform: none;
                background-color: white; 
                padding: 15px; 
                margin: 0;
                break-inside: avoid; /* Evitar que una tarjeta se divida */
            }
            
            /* Insertar un salto de página después de la décima tarjeta, si hubiera más */
            /* En este caso, al ser 10, salen 5 por columna en A4, llenando una página entera (2x5=10) */
            
            /* Ajuste de colores de texto */
            .tarjeta-titulo {
                color: #222 !important; 
                border-bottom: 2px solid #ddd !important;
            }
            .tarjeta-item strong {
                 color: #555 !important;
                 font-size: 0.8em;
            }
            .tarjeta-item span, .dialogo-bloque, .pautas-lista li {
                color: #222 !important; 
            }
        }
        
        /* Responsive (Mantenemos la regla de una columna para móviles) */
        @media (max-width: 900px) {
             #resultado {
                 grid-template-columns: 1fr;
             }
             #resultado .tarjeta-impro {
                 border-right: none !important;
             }
        }
    </style>
</head>
<body>
    <h1>Diálogo Único</h1>
    <p class="instruccion"></p>
    
    <div class="botones-container">
        <button id="boton-generar" onclick="generarContenido()">Generar 10 Escenarios</button>
        <button id="boton-imprimir" style="display: none;" onclick="window.print()">Imprimir Documento</button>
    </div>
    
    <div id="resultado">
        <p class="instruccion" style="font-style: normal; text-align: center; margin-bottom: 0;">Pulsa el botón para generar tu set de ejercicios.</p>
    </div>


    <script>
        /* -------------------------------------------
            LÓGICA JAVASCRIPT MODIFICADA (10 Ejercicios Detallados)
            ------------------------------------------- */

        // --- CLAVE API Y CONFIGURACIÓN ---
        const API_KEY = 'AIzaSyBkw_hSk8yJdruIH-mOPWTvd4v7qVh-EyQ'; // **ATENCIÓN: Usa tu clave real aquí**
        const MODEL_NAME = 'gemini-2.5-flash';
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const TITULO_SECCION = 'EJERCICIO'; // Nuevo título de sección para la IA
        const NUM_TARJETAS = 10; // Fijo en 10


        // --- Lógica de Fallback Offline (10 ejercicios detallados) ---
        // Este es un ejemplo para que la aplicación funcione si la clave API no es válida.
        const tarjetasOffline = [
            {titulo: "El Último Mensaje", dialogo: ["— El vuelo se ha cancelado.", "— ¿Qué? Pero lo necesito.", "— No hay más vuelos esta semana.", "— Nos prometiste que..."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["Definir el motivo del viaje.","Mostrar la desesperación y la ira.","Relación: Desconocidos, pero unidos por la urgencia.","Ubicación: Una terminal de aeropuerto vacía."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "La Llave Perdida", dialogo: ["— La caja fuerte está abierta.", "— ¿Dónde está el collar?", "— Lo tenía aquí hace un minuto.", "— ¿Y si lo tiene él?"], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["Definir la gravedad de la pérdida.","Uno miente descaradamente sobre su coartada.","El collar es un objeto con una maldición familiar.","Relación: Hermanos, herederos del objeto."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "El Tercer Asiento (Trío)", dialogo: ["A: Este sitio está ocupado.", "B: No veo a nadie.", "A: Pero lo prometí.", "C: ¿Prometiste qué, A?", "A: Que siempre nos sentaríamos los tres.", "B: El se fue hace un año.", "C: A: ¡Cállate!"], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["Justificar la obsesión de A con el asiento vacío.","B debe intentar ser empático con A, pero está molesto.","C es una persona ajena que se mete en la disputa por curiosidad.","Ubicación: Un banco en un parque."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "El Silencio en el Búnker", dialogo: ["— Creo que dejaron de cavar.", "— ¿Estás seguro? Escucho algo.", "— No es nada. Solo el eco.", "— Si nos encuentran, ¿qué hacemos?"], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["Definir qué o quién les persigue.","Un personaje no cree al otro, está al borde del pánico.","El búnker es muy pequeño y claustrofóbico.","Relación: Padre e hijo adulto."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "La Cena de la Traición", dialogo: ["— El vino está excelente.", "— ¿Por qué me invitas, de verdad?", "— Quería celebrar. Por nosotros.", "— ¿Y el dinero?", "— No hablemos de eso aquí."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["La cena se siente forzada y tensa.","Uno de ellos ha perdido una gran suma de dinero por culpa del otro.","Mostrar el esfuerzo por mantener las apariencias.","Ubicación: Un restaurante muy lujoso y silencioso."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "La Figura en el Espejo", dialogo: ["— No es mi reflejo.", "— Deja de mirarte.", "— Pero me sonríe. Y yo no.", "— Está cansado, eso es todo."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["La figura en el espejo parece tener voluntad propia.","El personaje que no ve intenta ser racional y práctico.","La escena ocurre a altas horas de la madrugada.","Relación: Pareja de recién casados, agotados."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "El Juramento de Sangre", dialogo: ["— ¿Te atreves?", "— Me atrevo.", "— Esto es irreversible.", "— Ya lo sé. Por eso lo hago."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["Definir el juramento: ¿es un pacto de amor eterno o de venganza?","La atmósfera debe ser ritualística y solemne.","El personaje que pregunta tiene miedo de las consecuencias.","Ubicación: Un cementerio a medianoche."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "El Paquete Olvidado", dialogo: ["— ¿De quién es esa caja?", "— No es mía.", "— Estaba debajo de tu asiento.", "— Yo no la he visto."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["El paquete contiene algo ilegal o muy valioso.","La negación del personaje es excesiva y sospechosa.","La escena ocurre en un lugar público con mucha gente (cafetería).","Relación: Dos extraños que comparten una mesa."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "La Carga de la Culpa (Trío)", dialogo: ["A: Se lo dijiste, ¿verdad?", "B: Tenía que hacerlo.", "C: ¿Decirme qué?", "B: A: ¡No le digas nada!", "C: B: ¿Por qué me mienten los dos?", "A: C: El tiene la culpa, no yo.", "B: La culpa es de los tres."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["A y B culpan al otro, C es la víctima de un secreto.","El secreto debe ser una acción conjunta de A y B.","La escena debe escalar rápidamente de la tensión al grito.","Relación: Tres mejores amigos de la infancia."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
            {titulo: "La Última Decisión", dialogo: ["— Solo quedan dos dosis.", "— Él las necesita más que yo.", "— No seas estúpida. Yo soy el doctor.", "— Pero él es nuestro hijo."], objetivo: "Profundizar en las circunstancias internas (motivaciones, miedos, deseos).", pautas: ["La medicina es la única esperanza de vida.","El conflicto es ético: salvar al ser querido o al proveedor.","El ambiente es de emergencia médica y desastre.","Relación: Esposos, ante un dilema de vida o muerte."], extension: "improvisar el “antes” y el “después” de la escena para completar la historia invisible."},
        ]; 

        function obtenerResultadosOffline() {
            let resultadoSimulado = '';
            tarjetasOffline.forEach((t, index) => {
                resultadoSimulado += `### ${TITULO_SECCION} ${index + 1}\n`;
                resultadoSimulado += `Título: ${t.titulo}\n`;
                resultadoSimulado += `Texto base:\n`;
                t.dialogo.forEach(linea => {
                    resultadoSimulado += `${linea}\n`;
                });
                resultadoSimulado += `Objetivo: ${t.objetivo}\n`;
                resultadoSimulado += `Pautas:\n`;
                t.pautas.forEach((pauta, idx) => {
                    resultadoSimulado += `${idx + 1}. ${pauta}\n`;
                });
                resultadoSimulado += `Extensión opcional: ${t.extension}\n\n`;
            });
            return resultadoSimulado.trim();
        }

        // --- FUNCIONES AUXILIARES ---
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function construirPrompt() {
            // ESTE ES EL PROMPT DETALLADO QUE PIDE TU EJERCICIO
            const contexto = `Genera ${NUM_TARJETAS} ejercicios teatrales breves para improvisación.
            
            Instrucciones para la respuesta y el formato ESTRICTO:

            1.  Cada ejercicio debe ocupar un bloque de texto separado y debe estar claramente numerado.
            2.  Cada ejercicio debe tener un **título distintivo y llamativo** (Ej: "La Promesa Rota", "El Reencuentro").
            3.  Debes incluir el separador **"Texto base:"** seguido de entre 4 y 7 líneas de diálogo breves. Cada frase debe comenzar con un guion largo (—) para simular el diálogo teatral.
                * Si es para 2 personajes, que cada uno tenga dos frases (máximo 5 frases en total).
                * Si es para 3 personajes (debe haber al menos 2 en total), marca quién habla con A / B / C antes de cada frase, procurando que cada uno tenga al menos dos intervenciones (máximo 7 frases en total).
            4.  Después del diálogo, añade este bloque: **"Objetivo: Profundizar en las circunstancias internas (motivaciones, miedos, deseos)."**
            5.  Luego, escribe un apartado de **"Pautas:"** con 4 puntos de guía adaptados al contenido del diálogo (no genéricos).
            6.  Termina siempre con el texto: **"Extensión opcional: improvisar el “antes” y el “después” de la escena para completar la historia invisible."**

            **REGLA DE FORMATO ESTRICTA:** Delimita cada ejercicio con el título EXACTO: **### ${TITULO_SECCION} [NÚMERO]**
            **Asegúrate de incluir al menos 2 ejercicios para tres personajes (A, B, C).**

            Ejemplo del formato de respuesta requerido (incluyendo la línea 'Título:'):
            ### ${TITULO_SECCION} 1
            Título: El Silencio del Muelle
            Texto base:
            — ¿Me viste?
            — No puedo mentirte.
            — ¿Y ahora qué?
            — Es tu decisión.
            Objetivo: Profundizar en las circunstancias internas (motivaciones, miedos, deseos).
            Pautas:
            1. El personaje que habla primero no puede levantar la mirada.
            2. Definir por qué el muelle es un lugar peligroso para ambos.
            3. El secreto debe involucrar a una tercera persona.
            4. El personaje más activo debe mostrar la calma antes de la tormenta.
            Extensión opcional: improvisar el “antes” y el “después” de la escena para completar la historia invisible.
            `;
            
            return contexto;
        }


        // --- FUNCIÓN PRINCIPAL DE RENDERIZADO (Adaptada al nuevo formato) ---
        async function generarContenido() {
            const resultadoDiv = document.getElementById('resultado');
            const botonGenerar = document.getElementById('boton-generar');
            const botonImprimir = document.getElementById('boton-imprimir');
            
            // 1. INICIO: Mostrar Carga Y Bloquear Botón
            botonGenerar.disabled = true;
            botonImprimir.style.display = 'none';

            const loadingOverlay = document.createElement('div');
            loadingOverlay.classList.add('loading-overlay'); 
            loadingOverlay.innerHTML = `
                <div class="windmill"></div>
                <span class="loading-text">Generando ${NUM_TARJETAS} escenarios detallados...</span>
            `;
            resultadoDiv.innerHTML = ''; 
            resultadoDiv.appendChild(loadingOverlay);

            const usarIA = API_KEY && API_KEY !== 'AIzaSyBkw_hSk8yJdruIH-mOPWTvd4v7qVh-EyQ' && API_KEY.startsWith('AIzaSy'); 
            let textoGenerado;
            let modo = usarIA ? 'IA' : 'Fallback Offline (Clave Inválida)';
            
            try {
                // Lógica de generación (IA o Fallback)
                if (usarIA) {
                    const prompt = construirPrompt();
                    
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ role: "user", parts: [{ text: prompt }] }],
                            generationConfig: { 
                                temperature: 0.9, 
                                maxOutputTokens: 2048,
                            }
                        })
                    });

                    if (!response.ok) {
                        modo = 'Fallback Offline (Error API)';
                        textoGenerado = obtenerResultadosOffline();
                        await sleep(1000); 
                    } else {
                        const data = await response.json();
                        textoGenerado = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || obtenerResultadosOffline();
                        if (!data.candidates?.[0]?.content?.parts?.[0]?.text?.trim()) {
                            modo = 'Fallback Offline (Respuesta vacía)';
                        }
                    }
                } else {
                    await sleep(800); 
                    textoGenerado = obtenerResultadosOffline();
                }
                
                if (!textoGenerado) throw new Error("No se pudo generar contenido.");

                // 2. PROCESAMIENTO Y RENDERIZADO DEL FORMATO DETALLADO
                const partes = textoGenerado.split('###').filter(parte => parte.trim().startsWith(TITULO_SECCION));
                let htmlResultado = '';
                
                partes.forEach((parte) => {
                    const lines = parte.trim().split('\n').map(line => line.trim()).filter(line => line.length > 0);
                    if (lines.length < 5) return; // Mínimo de líneas esperado

                    const data = {
                        titulo: 'Ejercicio sin Título',
                        textoBase: [],
                        objetivo: 'Objetivo no especificado por la IA.',
                        pautas: [],
                        extension: 'Extensión no especificada por la IA.'
                    };

                    let currentSection = 'start';
                    lines.forEach(line => {
                        if (line.startsWith('Título:')) {
                            data.titulo = line.replace('Título:', '').trim();
                        } else if (line.startsWith('Texto base:')) {
                            currentSection = 'dialogo';
                        } else if (line.startsWith('Objetivo:')) {
                            data.objetivo = line.replace('Objetivo:', '').trim();
                            currentSection = 'objetivo';
                        } else if (line.startsWith('Pautas:')) {
                            currentSection = 'pautas';
                        } else if (line.startsWith('Extensión opcional:')) {
                            data.extension = line.replace('Extensión opcional:', '').trim();
                            currentSection = 'extension';
                        } else if (currentSection === 'dialogo' && line.trim().length > 0) {
                            data.textoBase.push(line);
                        } else if (currentSection === 'pautas' && line.trim().match(/^\d+\.\s/)) {
                            data.pautas.push(line.replace(/^\d+\.\s*/, '').trim());
                        } else if (currentSection === 'objetivo' && currentSection === 'dialogo') {
                             // Capturar el cuerpo del objetivo si no estaba en la misma línea
                             if (data.objetivo.length === 0) data.objetivo = line.trim();
                        }
                    });


                    // Generación del HTML para la tarjeta detallada
                    let dialogoHTML = data.textoBase.map(l => `<span>${l}</span>`).join('');
                    let pautasHTML = data.pautas.map(p => `<li>${p}</li>`).join('');

                    let tarjetaHTML = `<div class="tarjeta-impro">`;
                    tarjetaHTML += `<div class="tarjeta-titulo">${data.titulo}</div>`;
                    tarjetaHTML += `<div class="separador"></div>`;
                    
                    // Texto Base
                    tarjetaHTML += `<div class="tarjeta-item"><strong>Texto Base</strong><div class="dialogo-bloque">${dialogoHTML}</div></div>`;
                    
                    // Objetivo
                    tarjetaHTML += `<div class="tarjeta-item"><strong>Objetivo</strong><span>${data.objetivo}</span></div>`;
                    
                    // Pautas
                    tarjetaHTML += `<div class="tarjeta-item"><strong>Pautas</strong><ul class="pautas-lista">${pautasHTML}</ul></div>`;
                    
                    // Extensión
                    tarjetaHTML += `<div class="tarjeta-item"><strong>Extensión Opcional</strong><span class="extension-bloque">${data.extension}</span></div>`;

                    tarjetaHTML += `</div>`;
                    htmlResultado += tarjetaHTML;
                });

                // 3. FINALIZACIÓN: Mostrar Contenido y Botones
                loadingOverlay.remove();
                
                // Renderizar
                resultadoDiv.innerHTML = htmlResultado;
                resultadoDiv.innerHTML += `<div class="modo-tag">[Modo: ${modo}]</div>`;
                botonGenerar.disabled = false;
                botonImprimir.style.display = 'inline-block';

            } catch (error) {
                // Manejo de ERRORES CRÍTICOS
                loadingOverlay.remove();
                resultadoDiv.innerHTML = `
                    <strong style="color: #c0392b;">Error crítico:</strong> ${error.message}.<br><br>
                    <strong>¡AVISO!</strong> Fallo de conexión o respuesta inesperada.
                    <div class="modo-tag">[Modo: ${modo}]</div>
                `;
                botonGenerar.disabled = false;
                botonImprimir.style.display = 'none';
            }
        }

        // Se mantiene la función global para que el onclick del botón funcione
        window.generarContenido = generarContenido; 
    </script>

<hr class="noprint" style="margin-top: 40px; border-color: #ccc;">
    <div class="noprint" style="text-align: center; margin-top: 20px; padding-bottom: 20px;">
        <a href="index.html" style="
            text-decoration: none;
            color: #5f6368;
            font-weight: bold;
            padding: 10px 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            transition: background-color 0.3s;
        ">
            ← Volver al Menú Principal
        </a>
    </div>

</body>
</html>